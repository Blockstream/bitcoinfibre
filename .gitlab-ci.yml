variables:
  XBUILDER_IMAGE: $DOCKER_REGISTRY/satellite/bitcoinsatellite:latest

builder:
  image: docker
  stage: .pre
  only:
    refs:
      - web
  before_script:
    - echo "$CI_BUILD_TOKEN" | docker login -u gitlab-ci-token --password-stdin $DOCKER_REGISTRY
  script:
    - docker pull $XBUILDER_IMAGE || true
    - docker build -f docker/builder.docker -t $XBUILDER_IMAGE .
    - docker push $XBUILDER_IMAGE

test:
  image: $XBUILDER_IMAGE
  stage: test
  script:
    - ./autogen.sh
    - ./configure --disable-wallet --enable-debug --with-gui=no
    - make -j$(nproc)
    - make check

xcompile:
  image: $XBUILDER_IMAGE
  stage: build
  only:
    refs:
      - web
  parallel:
    matrix:
      - HOST: ["aarch64-linux-gnu", "arm-linux-gnueabihf"]
  script:
    - ./autogen.sh
    - ./configure --disable-wallet --prefix=/src/depends/$HOST --enable-glibc-back-compat --enable-reduce-exports LDFLAGS=-static-libstdc++
    - make -j$(nproc)
  artifacts:
    paths:
      - src/bitcoind
      - src/bitcoin-cli
